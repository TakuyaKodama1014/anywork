# 規模が膨らんで開発スピードが落ちてきたモノリスアプリケーションを正しく分割する⽅法


## なぜリアーキテクチャが必要になるのか︖


最初は⼩さな機能でシンプルに実装

• ⼩規模な開発では、フレームワークの機能によってシンプルに実装が可能
• データベースはトランザクションで⼀貫性を容易に確保
• ビジネスロジックは単純なCRUDやORマッパーでの実装が中⼼
• 少⼈数での開発に最適
• デプロイメントはモノリスでシンプル


ビジネスが成⻑し機能が追加され徐々に複雑に…
異なる機能から共通のデータへアクセスが増加
徐々にパフォーマンスも課題に…

さらにビジネスロジックが他のレイヤーに漏れ出す

• コードの⾒通しが悪くなり、機能追加や修正が及ぼす影響が不明に
• 共通ライブラリの修正による影響が⼤きくなる
• データベーススキーマの変更が他の機能に影響を与える
• デプロイメントまでの⼯程が次第に重厚⻑⼤になり⼀⼤イベントになる


利⽤者が増加しスケーラビリティーの確保が必要

• スケールの単位がモノリス全体
• スケールしなくても良いものまで同時にスケール
• データベースは負荷が増⼤しスケールアップも限界に
• この問題は、そのままコンテナ化しても課題は変わらず


サービスの分割を検討するタイミングに

- この段階になると
    - コードが複雑化し⾒通しが悪くなる
    - 影響範囲の調査⼯数が増加し、コードの修正⼯数が増⼤
    - 修正によるバグの増加
    - ⼤量のリグレッションテストの実施によるデプロイまでの⼯数の増⼤
    - 結果としてリリース頻度が低下



## マイクロサービスアーキテクチャのトレードオフ


マイクロサービスにリアーキテクチャする理由

• デプロイの影響範囲を⼩さくする
• 機能的な⾃律性と単⼀責任の原則
• 開発速度の向上
• スケーリングの最適化
• コストの最適化


マイクロサービスが良い選択肢ではない場合

• サービスの分割単位が不明確
    • サービスの境界を間違えるとコストがかかる可能性
• 開発メンバーが少数
    • 開発メンバーのリソースがボトルネック
• 単純なCRUDのみの⼩規模なアプリケーション
    • マイクロサービスの複雑性が却って⾜枷に
• 正当な理由がない
    • 「流⾏っているから」「他がやっているから」で始めるのは危険


## ではどうやってサービスを分割するのか

### ドメイン駆動設計によるサービスの分割

戦略的設計
• ビジネスドメインを理解する
•
”ほとんどのソフトウェアプロジェクトの重要な複雑性は、ドメインそのものを
理解することにある“ –「ドメイン駆動設計」より
• 境界づけられたコンテキストからドメインを定義する
• コンテキストマッピングを定義する


ビジネスドメインの理解

分割されたドメインをサービスの単位にする
• ビジネスドメイン全体の中を責務で分割


### ドメイン分割を導くのための Event Storming

Event Stormingの概要

• ⾼品質なモデリングのための簡単なワークショップ
• ドメインエキスパートと開発者が協⼒して実施
• 業務から、境界づけられたコンテキストとモデルを導き出す


Event Stormingの流れ - Big Picture

• ビジネスイベントの洗い出し、時系列化
• Pivotal Event (分割点になるイベント)をマーク
• スイムレーン(並⾏処理、条件分岐) の発⾒
• 関係者/外部システムを洗い出し
• 上記完了後に、ナレーション/ウォークスルーを実施
• 対象領域の業務全体の流れを掴む


Event Stormingの流れ – Process Modeling

洗い出したイベントをつないでプロセスをモデル化
• コマンド
• アクター
• リードモデル
• ポリシー
• システム
• ホットスポット


Event Stormingの流れ –Software Design

• 集約を⾒つける、名前をつける
• 境界づけられたコンテキストを⾒つける
• 設計の詳細に⼊り、コーディングに進められるようにする

ドメインイベントの洗い出し
時系列に並べてPivotal Event をマーク
疑問点や課題はホットスポットで記録
スイムレーンで並列処理や条件分岐の洗い出し
関係者や外部システムの洗い出し
コマンドの洗い出し
アクター、リードモデルの洗い出し
ポリシーの洗い出し
集約を⾒出す
境界づけられたコンテキストを⾒出す



## ドメインモデルの実装


⾒出した集約を中⼼にドメインモデルを設計する

境界づけられたコンテキストとドメインモデル

データソースをサービスの所有ごとに分割

    作成したドメインモデルをコードに反映
    TDD（テスト駆動開発）で実装
    ドメインモデルはピュアなビジネスロジックを実装するため
    テスト駆動開発と相性が良い
    モデルと実装は繰り返し改善する

    この段階ではドメインモデルのみ実装（インフラコードからの分離）
        依存関係逆転の原則により、ドメイン層をシステム的な関⼼ごとから分離
        ヘキサゴナル/オニオン/クリーンアーキテクチャ

作成したドメインモデルをコードに反映

ユースケースからシーケンス図を作成しメソッドを洗い出す


## ドメインモデルのシステムへのマッピング

ビジネスドメイン全体

コンテキスト境界でドメインを分割

コアドメインとサブドメインを洗い出し

コンテキスト間をマッピング

ドメイン間はドメインイベントで連携
• ドメインイベントは境界づけられたコンテキストのビジネス上の重要な出来事を記録
• コンテキスト内や、他の境界づけられたコンテキストによって消費される
• ⾼凝集、疎結合、および独⽴したデプロイ能⼒を推進


ドメイン間の連携にイベント駆動アーキテクチャを利⽤


ドメインモデルから物理アーキテクチャへ

論理アーキテクチャを定義
• ⾮機能要件の設計
• サポートサービスに展開する（認証、分散トランザクション管理、キャッシングなど）
• 普遍的な課題にパターンを適⽤（SAGA、CQRSなど）
• ADR（Architecture Decision Records）を記述し、複雑性の管理にフォーカス
• この段階ではまだAWSのサービスにはマッピングしない


論理アーキテクチャへのマッピング

物理アーキテクチャへのマッピング
• AWS Well-Architectedの推奨を利⽤して⾮機能要件の要求を満たす
• AWSのサービスにマッピング
• ADR（Architecture Decision Records）を記述


## ドメインモデルのインフラストラクチャコードからの分離

クリーンアーキテクチャ
• 依存性のルール︓ソースコードの依存性は、内側（上位レベルの⽅向）だけに向かっていなければならない。
• エンティティ︓最重要なビジネルルールをカプセル化したもの
• ユースケース︓アプリケーション固有のビジネスルール
• インターフェイスアダプタ︓ユースケースやエンティティに便利なフォーマットから外部エージェントに便利なフォーマットに変換するレイヤー
• フレームワークとドライバ︓データベースやWebフレームワークなど。


まとめ

• 変化に対応し続けるためにアーキテクチャを適宜選択する
• サービスの分割にドメイン駆動設計を活⽤する
• Event Stormingはビジネスイベントによって境界を⾒出す⼿法
• ドメイン間をイベント駆動アーキテクチャで連携する
• ドメインモデルをTDDで実装し正しさを確認する
• ⾮機能要件を適⽤するために論理アーキテクチャにマップする
• ドメインモデルから外部へのアクセスを⾏うコードを分離する

